<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="author" content="Jenna Sloan">
<title>Fez Clock Tower Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
	font-family: monospace;
	padding: 0;
	margin: 0;
}
noscript {
	position: absolute;
	z-index: 9999999;
	color: white;
	background-color: black;
	height: 100vh;
	width: 100vw;
	font-size: min(100vh, calc(100vw / 30));
	line-height: 100vh;
	text-align: center;
}
#clockcontainer {
	display: flex;
	gap: 0px;
	max-width: min(100em, 200vh);
	/*max-height: 50vh;*/
}
svg {
	height: auto;
	width: min(100%, 50vh);
	aspect-ratio: 1 / 1;
	/*max-height: 256px;*/
	/*max-width: 256px;*/
	--color: attr(data-color);
}
.handinfo{
	display: block;
}
svg[data-valid="true"]{
	use[href$="clockcore" i]{
		stroke: #010;
	}
}
svg[data-valid="false"]{
	use[href$="clockcore" i]{
		stroke: #100;
	}
	
}
span[data-valid="true"]{
	background-color: #DFD;
}
span[data-valid="false"]{
	background-color: #FDD;
}
#interactive-area {
	padding-inline: 1ex;
}
#interactive-area > * {
	margin-block: 1ex;
}
/* Media Queries for responsiveness */
@media (max-width: 60vh) {
	#clockcontainer {
		display: grid;
		grid-template-columns: repeat(2, 1fr); /* 2 squares per row */
	}
}

@media (max-width: 13vh) {
	#clockcontainer {
		display: grid;
		grid-template-columns: 1fr; /* 1 square per row */
	}
}
</style>
<link rel='stylesheet' href='TableStyles.css' id="TableStyles" />
<script id="clockscript">
let actualstarttime = Date.now();
Object.defineProperty(window, 'starttime', {
	get: function() {
		return actualstarttime;
	},
	set: function(value) {
		actualstarttime = Number(value);
		const elem = document.getElementById("starttimeinput");
		elem.value = value;
		elem.onchange();
		document.querySelectorAll("[data-nextstamp]").forEach(a=>a.removeAttribute("data-nextstamp"));
	}
});
let actualoffsettime = 0;
Object.defineProperty(window, 'offsettime', {
	get: function() {
		return actualoffsettime;
	},
	set: function(value) {
		actualoffsettime = Number(value);
		const elem = document.getElementById("offetfromsysteminput");
		elem.value = value;
		elem.onchange();
		document.querySelectorAll("[data-nextstamp]").forEach(a=>a.removeAttribute("data-nextstamp"));
	}
});
function resetStartTime(){
	starttime = Date.now();
}
document.addEventListener("DOMContentLoaded",function(){
	starttime = Date.now();
	offsettime = 0;
	const handinfobox = document.getElementById("handinfobox");
	const template_clockvalidarea = document.getElementById("clockvalidarea");
	const template_clockhand = document.getElementById("clockhand");
	const handstuff = [];
	const clockfacefillopacity = window.getComputedStyle(document.getElementById("clockface")).fillOpacity;
	document.querySelectorAll(".clock").forEach(clock=>{
		const hand = template_clockhand.cloneNode();
		hand.removeAttribute("id");
		clock.insertBefore(hand, clock.lastElementChild);
		
		const validarea = template_clockvalidarea.cloneNode();
		validarea.removeAttribute("id");
		clock.appendChild(validarea);
		
		const colorname = clock.dataset.name;//clock.getAttribute("style").split(":").at(-1);
		const colorval = window.getComputedStyle(clock).getPropertyValue("--color");
		const bgcolor = "color-mix(in srgb, transparent 100%, "+colorval+" "+(100*clockfacefillopacity)+"%)";
		
		const handinfoname = document.createElement("span");
		handinfoname.textContent = colorname;
		handinfoname.style.backgroundColor = bgcolor;
		handinfoname.style.outline = "1px solid "+colorval;
		
		const handinfovalid = document.createElement("span");
		handinfovalid.textContent = "false";
		
		const handinfonextvalid = document.createElement("span");
		handinfonextvalid.textContent = "000";
		
		const handinfo = document.createElement("span");
		handinfo.appendChild(handinfoname);
		handinfo.append(" hand is valid? ");
		handinfo.appendChild(handinfovalid);
		handinfo.append(". Will next be valid at about: ");
		handinfo.appendChild(handinfonextvalid);
		handinfo.classList.add("handinfo");
		handinfobox.appendChild(handinfo);
		handstuff.push([clock, hand, handinfovalid, handinfonextvalid, validarea]);
	});
	
	function getXY(cx, cy, radius, theta){
		return [cx + radius*Math.cos(theta),
				cy + radius*Math.sin(theta)];
	}
	function createWedge(cx, cy, radius, validThetaStart, validThetaEnd) {
		const [sx,sy] = getXY(cx, cy, radius, validThetaStart);
		const [ex,ey] = getXY(cx, cy, radius, validThetaEnd);
		const largeArcFlag = Math.abs(validThetaEnd - validThetaStart)>Math.PI ? 1 : 0;
		
		return `M${cx},${cy}L${sx},${sy}A${radius},${radius} 0 ${largeArcFlag} 1 ${ex},${ey}z`;
	}
	function setHandLine(cx, cy, hand, radius, theta){
		hand.setAttribute("x1", cx+"px");
		hand.setAttribute("y1", cy+"px");
		const [x2,y2] = getXY(cx, cy, radius, theta);
		hand.setAttribute("x2", x2 +"px");
		hand.setAttribute("y2", y2 +"px");
		//hand.setAttribute("data-angle", (theta+Math.PI)%(2*Math.PI));
	}
	function moveHands(timestamp){
		const currtime = Date.now() + offsettime;
		formatTimeLabel(document.getElementById("currtime"), new Date(currtime));
		handstuff.forEach(([clock, hand, handinfovalid, handinfonextvalid, validarea])=>{
			const radius = Number(window.getComputedStyle(clock).getPropertyValue("--radius").replace("px",""));
			//const radius = 48;
			const clockbox = clock.viewBox.animVal;
			const cx = (clockbox.x + clockbox.width)/2;
			const cy = (clockbox.y + clockbox.height)/2;
			const val = currtime - starttime;
			const valmod = Number(clock.dataset.scale);
			const theta = ((val) / valmod) * (2 * Math.PI) - (Math.PI);
			
			//adjust the hands
			{
				const handstyle = window.getComputedStyle(hand);
				const handstrokewidth = Number(handstyle.strokeWidth.replace("px",""));
				const handlinecap = handstyle.strokeLinecap;
				const radiusadjust = (handlinecap=="butt" || handlinecap=="") ? 0 : handstrokewidth;
				setHandLine(cx, cy, hand, radius-radiusadjust, theta, val);
			}
			//update validity information
			{
				let thetaAdjusted = (theta - Math.PI)%(2*Math.PI);
				while(thetaAdjusted<0){
					thetaAdjusted += (2*Math.PI);
				}
				const validThetaLeeway = Number(clock.dataset.validThetaLeeway);
				const validThetaStart = Number(clock.dataset.validThetaStart ?? ((Math.PI/2)-validThetaLeeway));
				const validThetaEnd = Number(clock.dataset.validThetaEnd ?? ((Math.PI/2)+validThetaLeeway));
				
				validarea.setAttribute("d", createWedge(cx, cy, radius, validThetaStart + Math.PI, validThetaEnd + Math.PI));
				
				const inTheZone = thetaAdjusted >= validThetaStart && thetaAdjusted <= validThetaEnd;
				if(String(handinfovalid.dataset.valid) != String(inTheZone) || String(clock.dataset.valid) != String(inTheZone)){
					clock.dataset.valid = inTheZone;
					handinfovalid.dataset.valid = inTheZone;
					handinfovalid.textContent = inTheZone;
				}
			}
			//check the next valid timestamps
			{
				//const curval = (val+.75*valmod)%valmod;
				//hand.setAttribute("data-value", curval);
				let stampchanged = !hand.dataset.nextstamp;
				let nextstamp = Number(hand.dataset.nextstamp ?? (starttime+.25*valmod));
				while(nextstamp<currtime){
					nextstamp += valmod;
					stampchanged = true;
				}
				hand.setAttribute("data-nextstamp", nextstamp);
				if(stampchanged){
					formatTimeLabel(handinfonextvalid, new Date(nextstamp));
				}
			}
		});
		window.requestAnimationFrame(moveHands);
	}
	window.requestAnimationFrame(moveHands);
});
</script>
</head>
<body>
<div id="clockcontainer" style="--hand-width: 6px; --radius: 48px; --core-size: 10px;">
<template id="example" xmlns="http://www.w3.org/2000/svg">
<line />
</template>
<svg style="/*display: none !important;*/ height: 0; width: 0; overflow: hidden;" hidden="hidden" aria-hidden="true" focusable="false">
	<defs>
		<!-- use these with the <use> element -->
		<rect id="clockface" x="0" y="0" width="100" height="100" stroke-width="4" fill-opacity="0.05" stroke-opacity="1" fill="var(--color)" stroke="var(--color)" />
		<!--rect id="clockcorebase" x="45" y="45" width="10" height="10" stroke-width="2" stroke-opacity="1" /-->
		<rect id="clockcorebase" x="50" y="50" width="var(--core-size)" height="var(--core-size)" stroke-width="2" stroke-opacity="1" style="transform: translate(-50%, -50%); transform-box: fill-box;"/>
		<use id="clockcore" href="#clockcorebase" fill-opacity="0" fill="none" />
		<mask id="clockcoremask" maskUnits="userSpaceOnUse">
			<rect x="0" y="0" width="100" height="100" fill-opacity="1" fill="white" />
			<use href="#clockcorebase" fill-opacity="1" fill="black" stroke="black" />
		</mask>
		
		<!-- Note: These elements are templates to be cloned and animated with JavaScript -->
		<line id="clockhand" x2="50" y2="50" stroke-width="var(--hand-width)" stroke-opacity="1" stroke="var(--color)" stroke-linecap="square" />
		<path id="clockvalidarea" stroke-width="1" stroke-opacity="0" stroke="none" fill-opacity="0.05" fill="black" mask="url(#clockcoremask)" />
	</defs>
</svg>
<svg class="clock" viewbox="0 0 100 100" height="100" width="100" style="--color:red" data-name="Red" data-scale="60000" data-valid-theta-start="1.19579637" data-valid-theta-end="1.69579637">
	<use href="#clockface" />
	<use href="#clockcore" />
</svg>
<svg class="clock" viewbox="0 0 100 100" height="100" width="100" style="--color:green" data-name="Green" data-scale="3600000" data-valid-theta-leeway="0.125">
	<use href="#clockface" />
	<use href="#clockcore" />
</svg>
<svg class="clock" viewbox="0 0 100 100" height="100" width="100" style="--color:blue" data-name="Blue" data-scale="86400000" data-valid-theta-leeway="0.125">
	<use href="#clockface" />
	<use href="#clockcore" />
</svg>
<svg class="clock" viewbox="0 0 100 100" height="100" width="100" style="--color:gray" data-name="White" data-scale="604800000" data-valid-theta-leeway="0.125">
	<use href="#clockface" />
	<use href="#clockcore" />
</svg>
</div>
<div id="interactive-area">
<script>
var timeformat = window.localStorage?.timeformat ?? "local_time";

window.setTimeout(()=>{
	//set selected item on timeformatselector to whatever matched window.localStorage.timeformat
	const timeformatselector = document.getElementById("timeformatselector");
	timeformatselector.value = window.localStorage?.timeformat ?? "local_time";
	timeformatselector.onchange();
}, 1000);

function formatTimeLabel(timelabel, dt){
	var ofst = dt.getTimezoneOffset();
	timelabel.dataset['local_time'] = dt.toString();
	timelabel.dataset['Locale_time_string'] = dt.toLocaleString();//doesn't display fractions of seconds
	timelabel.dataset['ISO_8601_-_UTC'] = dt.toISOString();
	timelabel.dataset['ISO_8601_-_local_time_zone'] = (new Date(dt - ofst * 60 * 1000)).toISOString().replace('Z',(-Math.sign(ofst) < 0 ? '-' : '+')+String(Math.abs(ofst/60*100)).padStart(4,'0').split(/(?=..$)/).join(':'));
	timelabel.dataset['Unix_timestamp_-_seconds_since_epoch'] = Math.floor(dt.getTime()/1000);
	timelabel.dataset['Unix_timestamp_-_milliseconds_since_epoch'] = dt.getTime();
	
	timelabel.textContent = timelabel.dataset[timeformat];
}
var doneloading = false;
var hashbrowns = ({});
function updateHashbrowns(inputelem){
	if(doneloading){
		hashbrowns[inputelem.id] = inputelem.value;
		setHashbrownsObject(hashbrowns);
	}
}
function loadHashbrowns(){
	var arrhashbrowns = getHashbrowns();
	var elemmeta = [];
	arrhashbrowns.forEach(a=>{
		var elem = document.getElementById(a[0]);
		if(elem){
			elem.value = a[1];
			hashbrowns[a[0]] = a[1];
		}else{
			delete arrhashbrowns[a[0]];
		}
	});
	doneloading = true;
}
window.addEventListener("load", loadHashbrowns);
document.addEventListener("load", loadHashbrowns);
function timeformatselectorchanged(formatselector){
	timeformat = formatselector.value;
	window.localStorage.timeformat = timeformat;
	
	//force refresh all timestamps
	document.querySelectorAll("[data-nextstamp]").forEach(a=>a.removeAttribute("data-nextstamp"));
	document.querySelectorAll("input[type=\"number\"]").forEach(a=>a.onchange(a));
	
	updateHashbrowns(formatselector);
}
function timeinput_change(timeinput, valcallback, updatelabel=true){
	if(timeinput.dataset.changing != "changing"){
		timeinput.dataset.changing = "changing";
		const t= Number(timeinput.value);
		valcallback(t);
		if(updatelabel){
			const timelabel = document.querySelector(".timelabel[for=\""+timeinput.id+"\"]");
			if(timelabel){
				var dt = new Date(t);
				formatTimeLabel(timelabel, dt);
			}
		}
		updateHashbrowns(timeinput);
	}
	timeinput.dataset.changing = "";
}
function creationtimeinput_change(timeinput){
	timeinput_change(timeinput, dt=>starttime=dt);
}
function offetfromsysteminput_change(timeinput){
	timeinput_change(timeinput, dt=>offsettime=dt, false);
}
const hash_sep_kv = "=";
const hash_sep_entries = "&";
function getHashbrowns(){
	var h = window.location.hash;
	if(h.startsWith("#")){
		h = h.slice(1);
	}
	return h.split(hash_sep_entries).filter(c=>c.length>0).map(a=>a.split(hash_sep_kv));
}
function setHashbrownsObject(hashbrowns){
	window.location.hash = Object.entries(hashbrowns).map(a=>a.join(hash_sep_kv)).join(hash_sep_entries)
}window.addEventListener("hashchange", function() {
    console.log("Hash changed to: " + window.location.hash);
});
</script>
<label for="timeformatselector">Display times in the format:</label>
<select id="timeformatselector" onchange="timeformatselectorchanged(this)">
<option value="local_time">local time</option>
<option value="ISO_8601_-_UTC">ISO 8601 - UTC</option>
<option value="ISO_8601_-_local_time_zone">ISO 8601 - local time zone</option>
<option value="Locale_time_string">Locale time string</option>
<option value="Unix_timestamp_-_seconds_since_epoch">Unix timestamp - seconds since epoch</option>
<option value="Unix_timestamp_-_milliseconds_since_epoch">Unix timestamp - milliseconds since epoch</option>
<!--
TODO use js to add choices from the keys mentioned for timelabel.dataset
to affect the outcome of the content set by formatTimeLabel
-->
</select><br />

<label for="currtime">Current time: </label>
<span class="timelabel" id="currtime"></span><br />

<label for="starttimeinput">File start time: </label>
<input id="starttimeinput" type="number" min="0" step="1000" onchange="creationtimeinput_change(this)" />
<label for="starttimeinput" class="timelabel"></label>
<br />

<label for="offetfromsysteminput">Adjust current time: </label>
<input id="offetfromsysteminput" type="number" step="1000" onchange="offetfromsysteminput_change(this)" />
<label for="offetfromsysteminput" class="">milliseconds ahead</label>
<br />

<button onclick="resetStartTime()">Reset clocks to current time</button>
<br />
<div id="handinfobox">
</div>
<br />
<br />
<noscript>
This page requires JavaScript
</noscript>
<div id="viewsourcebox" style="max-width: 40ch">
This web app created by <span id="createdbyspan">Jenna Sloan</span>
Last Modified: <span id="lastmodifiedspan"></span>
<a id="viewsource" target="_blank" href="https://github.com/Jenna1337/FezTools/blob/main/FezClockTowerSim.html">
View Source
<span> on GitHub</span><span><svg role="presentation" style="display: inline-block; width: 1em; height: 1em; vertical-align: top; fill: currentcolor;" viewbox="0 0 48 48">
<path d="M36 24c-1.2 0-2 0.8-2 2v12c0 1.2-0.8 2-2 2h-22c-1.2
0-2-0.8-2-2v-22c0-1.2 0.8-2 2-2h12c1.2 0 2-0.8 2-2s-0.8-2-2-2h-12c-3.4
0-6 2.6-6 6v22c0 3.4 2.6 6 6 6h22c3.4 0 6-2.6
6-6v-12c0-1.2-0.8-2-2-2z"></path>
<path d="M43.8 5.2c-0.2-0.4-0.6-0.8-1-1-0.2-0.2-0.6-0.2-0.8-0.2h-12c-1.2
0-2 0.8-2 2s0.8 2 2 2h7.2l-18.6 18.6c-0.8 0.8-0.8 2 0 2.8 0.4 0.4 0.8
0.6 1.4 0.6s1-0.2 1.4-0.6l18.6-18.6v7.2c0 1.2 0.8 2 2 2s2-0.8
2-2v-12c0-0.2 0-0.6-0.2-0.8z"></path>
</svg></span>
</a>
</div>
</body>
<script>
document.addEventListener("DOMContentLoaded",function(){
	try{
		var lm = document.getElementById("lastmodifiedspan");
		lm.textContent = (new Date(document.lastModified)).toISOString();
		lm.after(document.createElement("br"));
	}
	catch(error){
		console.error(error);
	}
	try{
		var cb = document.getElementById("createdbyspan");
		cb.textContent = Array.from(document.getElementsByTagName("meta"))
				.filter(function(a){var n=a.getAttribute("name"); return n && n.toLowerCase()==="author";})
				.map(a=>a.getAttribute("content"))
				.join(", ");
		cb.after(document.createElement("br"));
	}
	catch(error){
		console.error(error);
	}
});

function GetGithubSourceHref(){
	let h=window.location.hostname.split(".");
	let p=window.location.pathname.split("/").filter(a=>a.length>0);
	return "https://"+h[1]+".com/"+h[0]+"/"+p[0]+"/blob/main/"+(p[1] ?? "index.html");
}
if(window.location.hostname){
	let href = GetGithubSourceHref();
	if(href){
		document.getElementById("viewsource").href = href;
	}
}
</script>
</html>